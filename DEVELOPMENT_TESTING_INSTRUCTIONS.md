# SmashVision — Local Development & Testing Guide

## Why This Exists

Production uses a **production Clerk instance** (`pk_live_...`) and a **production MySQL database** on AWS RDS. When running the frontend locally, you cannot use the production Clerk instance — so you use the **development Clerk instance** (`pk_test_...`) instead. The problem is that dev Clerk users have completely different IDs than prod Clerk users, so they don't exist in the production database, and every protected route fails with "Not Found".

The solution is a **fully local dev stack**:

```
LOCAL FRONTEND          LOCAL API (port 5000)     LOCAL MySQL
(dev Clerk pk_test_) → (dev Clerk sk_test_)    → (smashvision_dev)
```

The `sync-dev-user.js` script bridges the gap: it takes your dev Clerk user and links it to your existing record in the local database, then updates Clerk's private metadata so the API can resolve you correctly.

---

## Prerequisites

- **Node.js 20.6+** (required for `--env-file` flag — run `node --version` to check)
- **MySQL 8.0** installed locally (MySQL Server + MySQL Workbench)
- **MySQL in your PATH** — if `mysql` isn't recognized in PowerShell, add `C:\Program Files\MySQL\MySQL Server 8.0\bin` to your system PATH

---

## One-Time Setup

Do this once. After this, the daily workflow is just two `npm run dev` commands.

### Step 1 — Create the local dev database

Open PowerShell and run:

```powershell
mysql -u root -p -e "CREATE DATABASE smashvision_dev;"
```

### Step 2 — Export schema + data + routines from production

Open **MySQL Workbench** and connect to the production RDS instance:

```
Host: database-prueba.cpmi8kiuw7c4.us-east-2.rds.amazonaws.com
User: admin
```

Go to **Server → Data Export** and configure:
- Select database: `DB_Prueba`
- Select all tables
- Export method: **Dump Data and Structure** (not schema only — you want the real data)
- Check **"Export Stored Procedures and Functions"** ← critical, otherwise statistics endpoints fail because it uses specified functions.
- Output: **Export to Self-Contained File** → save as e.g. `C:\Users\tomas\export.sql`

Click **Start Export**.

### Step 3 — Import into local dev database

In MySQL Workbench, connect to your **local** MySQL instance, then:

**Server → Data Import** → select the exported `.sql` file → set target schema to `smashvision_dev` → **Start Import**

> Your antivirus may flag the `.sql` file (IDP.Generic false positive), add exception to these files since it is plain SQL generated by mysqldump.

### Step 4 — Create the admin user locally

The stored procedures were created on RDS with `DEFINER='admin'@'%'`. Your local MySQL doesn't have that user, so procedure calls fail. Create it with full privileges:

```sql
CREATE USER 'admin'@'%' IDENTIFIED BY 'Bruno1226*';
GRANT ALL PRIVILEGES ON *.* TO 'admin'@'%' WITH GRANT OPTION;
FLUSH PRIVILEGES;
```

> **Why `GRANT ALL ON *.*` and not just `smashvision_dev.*`?**
> Stored procedures internally use `EXECUTE`, `CREATE TEMPORARY TABLES`, and cross-table `SELECT`. Scoped grants consistently miss one of these. Full access on `*.*` is safe for a local dev database.

### Step 5 — Clear all production Clerk IDs

The imported Users table has production Clerk IDs that are useless locally (they belong to the production Clerk instance). Clear them all so the sync script can match users by email instead:

```sql
UPDATE `smashvision_dev`.`users` SET `ClerkID` = NULL;
```

> **Important:** Use backtick syntax exactly as above. The bare form `UPDATE smashvision_dev.users SET ClerkID = NULL` silently affects 0 rows in MySQL Workbench due to safe update mode.

After running this, all 21 (or however many) users will have `NULL` in the ClerkID column. Their clips, videos, and other data remain intact.

### Step 6 — Configure environment files

These files are already set up in the repo. Verify they exist and contain the right values:

**`api/.env_development`** — API uses this when started with `npm run dev`:
```
PORT=5000
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=your_local_db_password
DB_NAME=smashvision_dev
CLOUDFLARE_API_KEY=...
CLOUDFLARE_ACCOUNT_ID=...
CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...
CLERK_WEBHOOK_SIGNING_SECRET=whsec_...
YOUTUBE_CLIENT_ID=...
YOUTUBE_CLIENT_SECRET=...
YOUTUBE_API_KEY=...
API_URL=http://localhost:5000
API_VERSION=1.0.1
```

**`smashVisionWeb/.env.development`** — Vite auto-loads this on `npm run dev`:
```
VITE_CLERK_PUBLISHABLE_KEY=pk_test_...
VITE_API_URL=http://localhost:5000
VITE_WS_URL=ws://localhost:5000
```

> Note: `smashVisionWeb/.env_development` (with underscore) is **not** loaded by Vite. Only `.env.development` (with dot) is.

---

## Daily Dev Workflow

### Terminal 1 — Start the API

```powershell
cd C:\Users\tomas\Desktop\smashVisionReplays\api
npm run dev
```

This runs `node --env-file=.env_development server.js`. The `--env-file` flag sets all env vars **before any module loads**, which is important because `db/db.js` calls `dotenv.config()` independently on startup.

### Terminal 2 — Start the frontend

```powershell
cd C:\Users\tomas\Desktop\smashVisionReplays\smashVisionWeb
npm run dev
```

Vite automatically loads `.env.development`, so the frontend points to `http://localhost:5000` and uses the dev Clerk instance.

Open [http://localhost:5173](http://localhost:5173) (or whichever port Vite picks).

---

## Syncing Your User (First Time or After Re-importing Prod Data)

After logging in locally with your dev Clerk account, run the sync script from the `api` folder:

```powershell
cd C:\Users\tomas\Desktop\smashVisionReplays\api
node --env-file=.env_development scripts/sync-dev-user.js you@youremail.com
```

You can also pass your dev Clerk user ID directly:

```powershell
node --env-file=.env_development scripts/sync-dev-user.js user_abc123xyz
```

**What the script does:**
1. Looks up your user in the **dev Clerk instance** by email or user ID
2. Connects to the **local dev MySQL database**
3. Checks if a user with your dev Clerk ID already exists → skips creation if so
4. If not found by Clerk ID, checks by **email** → links your dev Clerk ID to your existing prod record (preserving all your clips and videos)
5. If not found at all → creates a new user record
6. Updates your **dev Clerk private metadata** with your database user ID so the API can resolve you

After the script completes, **hard-refresh** the browser (`Ctrl+Shift+R`) — the dashboard should load with your data.

> You only need to run this once per user. After that, just `npm run dev` and go.

> This script creates the user as a member and in clerk metadata sets role "member" id "id_in_users_table". If you need the user to be a club, execute this script and then log in to clerk and set role to "club" and id to the "id_of_the_club_in_clubs_table"
---

## Re-syncing Prod Data (When You Want Fresh Data)

When prod has new data you want locally, repeat Steps 2–5 above (export, import, create admin user if needed, clear ClerkIDs), then re-run the sync script. The sync script handles the case where your user already exists — it will just re-link your dev Clerk ID.

---

## How Authentication Works Locally

```
1. You log in via dev Clerk in the browser
2. Frontend gets your dev Clerk user ID (e.g. user_38oez...)
3. Frontend calls GET http://localhost:5000/api/users/metadata/user_38oez...
4. Local API uses dev Clerk secret key → finds you in dev Clerk → returns your role + DB id
5. Frontend uses the DB id for all subsequent queries (clips, videos, etc.)
6. Everything resolves against the local smashvision_dev database
```

---

## Troubleshooting

| Error | Cause | Fix |
|-------|-------|-----|
| `Access denied for user 'admin'@'%'` | admin user not created locally | Run Step 4 |
| `execute command denied for routine` | admin lacks EXECUTE privilege | Run `GRANT ALL PRIVILEGES ON *.* TO 'admin'@'%' WITH GRANT OPTION;` |
| `SELECT command denied for table X` | Same — use `GRANT ALL ON *.*` not scoped grant | Run Step 4 again with `*.*` |
| `UPDATE ClerkID = NULL` affects 0 rows | MySQL Workbench safe update mode | Use backtick syntax from Step 5 |
| Antivirus blocks `.sql` file | IDP.Generic false positive | Restore from quarantine / add exclusion |
| `--env-file` not recognized | Node.js < 20.6 | Upgrade Node.js |
| Dashboard shows "Failed to load user metadata" | User not synced | Run the sync script |
